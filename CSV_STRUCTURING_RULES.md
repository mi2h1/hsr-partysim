# CSV構造化ルール - 崩壊スターレイル バフ・デバフ解析

## 1. 基本フォーマット

### 入力CSV（元データ）
```csv
キャラクター名,{名前},
属性,{属性},
運命,{運命},
バージョン,{実装バージョン},
通常攻撃,{スキル名},{説明文}
戦闘スキル,{スキル名},{説明文}
必殺技,{スキル名},{説明文}
天賦,{スキル名},{説明文}
秘技,{スキル名},{説明文}
追加効果1,{スキル名},{説明文}
追加効果2,{スキル名},{説明文}
追加効果3,{スキル名},{説明文}
星魂1,{星魂名},{説明文}
星魂2,{星魂名},{説明文}
...
星魂6,{星魂名},{説明文}
```

### 出力CSV（構造化データ）
```csv
キャラクター名,{名前},
属性,{属性},
運命,{運命},
バージョン,{実装バージョン},
スキル,{種別},{名前},{説明}
バフ,{スキル種別},{バフ名},{対象},{ステータス},{数値},{継続時間},{条件},{スタック可能},{最大スタック}
星魂,{レベル},{名前},{説明}
星魂強化,{レベル},{強化タイプ},{強化値}
```

## 2. 行タイプ詳細

### 2.1 基本情報行
- `キャラクター名,{名前},` - キャラクターの名前
- `属性,{属性},` - 物理、炎、氷、雷、風、量子、虚数
- `運命,{運命},` - 壊滅、巡狩、知恵、調和、虚無、存護、豊穣
- `バージョン,{実装バージョン},` - ゲーム実装バージョン（例：1.0、1.6、2.0など）**省略可能**

### 2.2 スキル行
```csv
スキル,{種別},{名前},{説明}
```
- **種別**: 通常攻撃、戦闘スキル、必殺技、天賦、秘技、追加効果1、追加効果2、追加効果3
- **名前**: スキルの正式名称
- **説明**: 元の説明文そのまま

### 2.3 バフ行
```csv
バフ,{スキル種別},{バフ名},{種別},{対象},{ステータス},{数値},{継続時間},{条件},{スタック可能},{最大スタック}
```
- **スキル種別**: どのスキルから発生するバフか
- **バフ名**: バフ効果の名称（例：与ダメージ増加、全属性耐性貫通）
- **種別**: 
  - `バフ`: **味方のステータスを向上させる効果**（攻撃力増加、与ダメージ増加、会心率増加、防御力増加、即時行動など）
  - `デバフ`: **敵のステータスを悪化させる効果**（受けるダメージ増加、防御力減少、速度減少、状態異常付与など）
  - `その他`: EP回復、状態付与（神の啓示、協奏など）、デバフ解除
  - **対象外**: 直接ダメージ（「敵に○○ダメージを与える」は抽出しない）

**重要原則**: 
- バフ・デバフはステータス変化のみ
- 直接ダメージ（通常攻撃、追加攻撃、付加ダメージなど）は抽出対象外
- 味方のステータス向上 = バフ
- 敵のステータス悪化 = デバフ

**攻撃行動とバフ効果の区別**:
- **攻撃行動そのもの**（「看破・滅を発動する」「カウンターを行う」など）はバフ・デバフ抽出対象外
- **攻撃に付随するステータス強化**（「攻撃時に会心率+15%」「カウンター時に攻撃力+30%」など）はバフとして抽出
- 例：雲璃の星魂6「看破・滅を発動してダメージを与える時、会心率+15%、物理属性耐性貫通+20%」
  - 「看破・滅の発動」→ 攻撃行動なので抽出対象外
  - 「会心率+15%、物理属性耐性貫通+20%」→ ステータス強化なのでバフとして抽出
- **対象**: 
  - 味方全体、味方単体、ロビン自身、トリビー自身
  - 敵全体、敵単体、敵隣接
  - フィールド（結界など）
- **ステータス**: 
  - 与ダメージ、受けるダメージ、攻撃力、防御力、HP、最大HP、速度
  - 会心率、会心ダメージ、効果命中、効果抵抗
  - 全属性耐性貫通、防御力無視、EP、行動順
  - 物理/量子/炎/氷/雷/風/虚数属性ダメージ
  - 状態付与（神の啓示、協奏、結界など）
- **数値**: 
  - 固定値: `+50%`、`+200`、`100%`
  - 変動値: `ロビンの攻撃力22.8%+200`、`最大HP18%`
  - 特殊: `解除`、`神の啓示`、`結界`
- **継続時間**: 
  - ターン数: `3ターン`、`2ターン`
  - 条件付き: `協奏状態中`、`神の啓示中`、`結界中`
  - 特殊: `永続`、`瞬間`、`戦闘開始時`
- **条件**: 
  - 発動条件の詳細説明
  - 例: `ロビンのターンで-1ターン`、`味方攻撃後`、`必殺技発動時`
- **スタック可能**: `true` または `false`
- **最大スタック**: 数値（スタック可能な場合のみ）

### 2.4 星魂行
```csv
星魂,{レベル},{名前},{説明}
```
- **レベル**: 1～6の数字
- **名前**: 星魂の正式名称
- **説明**: 元の説明文そのまま

### 2.5 星魂強化行
```csv
星魂強化,{レベル},{強化タイプ},{強化値}
```
- **レベル**: 1～6の数字
- **強化タイプ**:
  - `new_effect`: 新しい効果の追加
  - `enhancement`: 既存効果の強化
  - `skill_level`: スキルレベル上昇
- **強化値**: 
  - 数値: `+24%`、`120%`、`+729%`
  - スキルレベル: `必殺技+2`、`通常攻撃+1`
  - その他: `追加1回`、`解除`

## 3. 解析ルール

### 3.1 戦闘バフ・デバフの抽出
以下のスキルから発生する効果を「戦闘バフ・デバフ」として分類：
- 通常攻撃、戦闘スキル、必殺技、天賦、秘技、追加効果1～3

### 3.2 星魂効果の抽出
星魂1～6から発生する効果を「星魂効果」として分類：
- 星魂によって追加される新効果
- 星魂によって強化される既存効果
- スキルレベルの上昇

### 3.3 数値の抽出パターン
- パーセンテージ: `+50%`、`24%`、`729%`
- 固定値: `+200`、`+30`
- 計算式: `攻撃力の22.8%+200`、`最大HPの18%`
- 倍率: `120%分`、`150%に固定`

### 3.4 継続時間の判定
- ターン制: `3ターン継続`、`2ターン`
- 状態依存: `協奏状態の間`、`神の啓示がある時`
- 瞬間効果: 戦闘開始時のみ、必殺技発動時のみ
- 永続効果: 常時発動、パッシブ効果

### 3.5 対象の判定
- 味方系: 味方全体、味方単体、自身
- 敵系: 敵全体、敵単体、隣接する敵
- フィールド系: 結界、領域効果

## 4. 実例

### 入力例（robin.csv抜粋）
```csv
キャラクター名,ロビン,
属性,物理,
運命,調和,
バージョン,2.2,
戦闘スキル,飛翔のアリア,味方全体の与ダメージ+ 50% 、 3 ターン継続。ロビンのターンが回ってくるたびに継続時間-1ターン。
```

### 出力例（robin_structured.csv）
```csv
キャラクター名,ロビン,
属性,物理,
運命,調和,
バージョン,2.2,
スキル,戦闘スキル,飛翔のアリア,味方全体の与ダメージ+ 50% 、 3 ターン継続。ロビンのターンが回ってくるたびに継続時間-1ターン。
バフ,戦闘スキル,与ダメージ増加,バフ,味方全体,与ダメージ,+50%,3ターン,ロビンのターンで-1ターン,false,1
```

### 種別判定例
```csv
# 抽出対象
バフ,戦闘スキル,攻撃力増加,バフ,味方全体,攻撃力,+200,永続,,false,1
バフ,必殺技,受けるダメージ増加,デバフ,敵全体,受けるダメージ,+30%,永続,,false,1  
バフ,天賦,EP回復,その他,自身,EP,+5,永続,スキル使用時,false,1

# 抽出対象外（ダメージなので除外）
# 「敵単体に攻撃力120%分の物理属性ダメージ」→ 抽出しない
# 「追加攻撃で敵全体にHP18%分の量子ダメージ」→ 抽出しない
# 「通常攻撃で敵にダメージ」→ 抽出しない
```

## 5. 構造化プロセス

### 5.1 解析・確認ステップ（必須）
1. **解析フェーズ**: 元CSVファイルを読み込み、このルールに従って各行を解析
2. **解釈説明**: 以下の項目について解釈内容を文字で説明
   - 基本情報（名前、属性、運命、バージョン）
   - スキル構成（何個のスキルを抽出するか）
   - バフ・デバフ効果（何個の効果を抽出し、どう分類するか）
   - 星魂効果（どのような強化効果があるか）
   - 各スキルの対象解釈（どの対象に効果を及ぼすか）
   - 新ポリシー適用部分（攻撃行動とバフ効果の区別など）
3. **疑問点相談**: 解釈に迷いや悩みがある場合、構造化実行前に必ずユーザーに質問
   - 曖昧な表現の解釈方法
   - 複雑な条件分岐の扱い方
   - 新しいパターンの分類方法
   - 実例集に該当しない特殊ケース
4. **確認取得**: 解釈内容が正しいか確認を取る
5. **データ作成**: 確認後に構造化CSVファイルを作成

### 5.2 実装ステップ
1. 構造化CSVフォーマットで出力
2. データベースへインポート

### 5.3 解釈確認の重要性
- **誤解釈防止**: 複雑なスキル効果やターゲット指定の誤読を防ぐ
- **一貫性確保**: 他のキャラクターとの解釈の統一性を保つ
- **ポリシー適用**: 最新の解析ポリシーが正しく適用されているかの確認
- **疑問点解消**: 解釈に迷いがある場合は構造化実行前にユーザーに相談し、明確化してから進める

## 6. 注意事項

- **戦闘バフのみ抽出**: 純粋に戦闘中に発生する効果のみを「バフ」行として出力
- **星魂は別管理**: 星魂効果は「星魂」行と「星魂強化」行で管理
- **完全性**: 説明文に含まれるすべての数値効果を抽出する
- **正確性**: 数値は元の説明文から正確に転記する
- **一貫性**: 同じ種類の効果は同じ形式で記述する

## 7. 実例・特殊ケース集

### 7.1 状態付与による効果強化
**例：花火の必殺技「奇怪な謎」効果**
```csv
# 基本効果
バフ,必殺技,奇怪な謎状態付与,その他,味方全体,状態付与,奇怪な謎,2ターン,必殺技発動時,false,1
# 状態による強化効果
バフ,必殺技,奇怪な謎時天賦強化,バフ,奇怪な謎を持つ味方,与ダメージ,+10%×天賦層数,奇怪な謎継続中,奇怪な謎状態時の天賦効果,false,1
```
**解釈**: 状態付与と、その状態による既存効果の強化は別々のバフとして抽出

### 7.2 条件分岐による効果変化
**例：花火の追加効果3「量子キャラ数による攻撃力変化」**
```csv
バフ,追加効果3,攻撃力増加,バフ,味方全体,攻撃力,+15%,永続,常時,false,1
バフ,追加効果3,量子キャラ攻撃力増加1名,バフ,量子属性キャラ,攻撃力,+5%,永続,量子キャラ1名時,false,1
バフ,追加効果3,量子キャラ攻撃力増加2名,バフ,量子属性キャラ,攻撃力,+15%,永続,量子キャラ2名時,false,1
バフ,追加効果3,量子キャラ攻撃力増加3名,バフ,量子属性キャラ,攻撃力,+30%,永続,量子キャラ3名時,false,1
```
**解釈**: パーティ構成による条件分岐は、各条件を別々のバフとして抽出

### 7.3 ランダム効果の複数パターン
**例：銀狼の天賦「欠陥」システム**
```csv
バフ,天賦,欠陥（攻撃力減少）,デバフ,攻撃を受けた敵,攻撃力,-10%,3ターン,攻撃後100%確率,false,1
バフ,天賦,欠陥（防御力減少）,デバフ,攻撃を受けた敵,防御力,-12%,3ターン,攻撃後100%確率,false,1
バフ,天賦,欠陥（速度減少）,デバフ,攻撃を受けた敵,速度,-6%,3ターン,攻撃後100%確率,false,1
```
**解釈**: ランダムで選ばれる複数の効果は、それぞれ独立したバフとして抽出

### 7.4 累積可能なスタック効果
**例：花火の天賦「与ダメージアップ」**
```csv
バフ,天賦,与ダメージ増加,バフ,味方全体,与ダメージ,+6%,2ターン,SP消費1回につき,true,3
```
**解釈**: 「最大で◯層累積できる」→ `is_stackable: true, max_stacks: ◯`

### 7.5 他ステータス連動効果
**例：銀狼の追加効果3「効果命中連動攻撃力」**
```csv
バフ,追加効果3,効果命中連動攻撃力増加,バフ,銀狼自身,攻撃力,効果命中10%につき+10%,永続,最大+50%まで,false,1
```
**解釈**: 他ステータスに応じて変動する効果は、計算式を数値欄に記載

### 7.6 デバフ数連動効果
**例：銀狼の星魂6「デバフ数による与ダメージ増加」**
```csv
バフ,星魂6,与ダメージ増加,バフ,銀狼自身,与ダメージ,デバフ数×20%,永続,敵のデバフ数に応じて・最大100%,false,1
```
**解釈**: 敵のデバフ数など動的に変化する値に連動する効果の記載方法

### 7.7 特殊な状態埋め込み
**例：銀狼の戦闘スキル「弱点属性埋め込み」**
```csv
バフ,戦闘スキル,弱点属性埋め込み,デバフ,指定した敵単体,弱点属性,味方属性1つを埋め込み,3ターン,120%確率で発動,false,1
```
**解釈**: 通常のステータス変化以外の特殊効果も、対象ステータス欄に内容を記載

## 8. バージョン管理

- **バージョン形式**: "1.0", "1.6", "2.0", "2.2"など、ゲームの実装バージョンを記載
- **省略可能**: バージョン行を記載しない場合は、データベースでnullとして保存される
- **ソート順**: キャラクター一覧とパーティー編成では、バージョン降順（新しい順）でソート（null値は最後）
- **既存データ**: 既存キャラクターのバージョンは手動でデータベース更新が必要